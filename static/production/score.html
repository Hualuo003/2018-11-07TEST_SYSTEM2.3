<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>考试后台管理系统</title>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <script src="../vendors/nprogress/nprogress.js"></script>
    
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <link href="../vendors/select2/dist/css/select2.min.css" rel="stylesheet">
    
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../vendors/select2/dist/js/select2.full.min.js"></script>
    <script src="../vendors/jquery-table2excel-master/dist/jquery.table2excel.min.js"></script>
    <script src="../exam/js/config.js"></script>
    <!--<script src="../exam/js/AuthorityManagement.js"></script>-->
    
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>

    <!--Datatables--> 
	<link rel="stylesheet" type="text/css" href="../exam/css/jquery.dataTables.css">
	<script type="text/javascript" charset="utf8" src="../exam/js/jquery.dataTables.js"></script>
	<script src="../exam/js/handlebars-v3.0.1.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/js/dataTables.bootstrap.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/js/jquery.dataTables.js"></script>
    
    
    <style>
    table {
        *border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ccc;
    }

    .zebra td,
    .zebra th {
        padding: 10px;
        /*border-bottom: 1px solid #f2f2f2;*/
        border-left: 1px solid #ccc;
        border-top: 1px solid #ccc;
        text-align: left;
    }

    .zebra .alternate,
    .zebra tbody tr:nth-child(even) {
        background: #f5f5f5;
        box-shadow: 0 1px 0 rgba(255, 255, 255, .8) inset;
    }

    .zebra th {
        text-align: left;
        text-shadow: 0 1px 0 rgba(255, 255, 255, .5);
        border-bottom: 1px solid #ccc;
        background-color: #eee;
        background-image: -webkit-linear-gradient(top, #f5f5f5, #eee);
        background-image: -webkit-linear-gradient(top, #f5f5f5, #eee);
        background-image: -moz-linear-gradient(top, #f5f5f5, #eee);
        background-image: -ms-linear-gradient(top, #f5f5f5, #eee);
        background-image: linear-gradient(top, #f5f5f5, #eee);
        filter: progid: DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#f5f5f5, endColorstr=#eee);
        -ms-filter: "progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#f5f5f5,endColorstr=#eee)";
    }

    .zebra th:first-child {
        border-radius: 6px 0 0 0;
        /*width: 40px;*/
    }

    .zebra th:last-child {
        border-radius: 0 6px 0 0;
    }

    .zebra th:last-child {
        border-radius: 0 6px 0 0;
    }

    .zebra tr:last-child td:first-child {
        border-radius: 0 0 0 6px;
    }

    .zebra td:last-child {
        border-radius: 0 0 6px 0;
    }

    .pageNumber {
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        background: #dddddd;
        height: 40px;
        width: auto;
    }

    .page-list,
    .page-list li {
        list-style: none;
        display: block;
        padding: 0;
        margin: 0;
    }

    .page-list {
        margin: 0 auto;
    }

    .page-list li {
        float: left;
        margin: 0 5px;
    }

    .page-list a {
        color: #337ab7;
    }

    .page-active a {
        color: #FFFFFF;
    }

    td {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    a {
        cursor: pointer;
    }
    </style>
</head>

<body class="nav-md"  style="background-image: url(../vendors/tushuguan.jpg);background-repeat: no-repeat;background-size: cover;">
    <div class="container body">
        <div class="main_container" >
            <div id="menu">
             <!--加载侧边栏-->
            </div>
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="page-title">
                        <div class="title_left">
                            <h3>成绩管理 </h3>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>成绩统计</h2>
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li>
                                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    </br>
                                    <form class="form-horizontal form-label-left" id="class_data">
                                        <div>
                                            <label class="control-label col-md-1 col-sm-1 col-xs-6" style="float: left;">考试选择</label>
                                            <div class="col-md-3 col-sm-9 col-xs-6" style="float: left;">
                                                <select class="select2_single form-control" id="exam">
                                                </select>
                                                &nbsp;&nbsp;
                                            </div>
                                        </div>
                                        <div>
                                            <label class="control-label col-md-2 col-sm-3 col-xs-12" style="float: left;">教务班选择</label>
                                            <div class="col-md-3 col-sm-9 col-xs-12" style="float: left;">
                                                <select class="select2_single form-control" id="student_class">
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-9 col-xs-12">
                                            <button type="button" class="btn btn-dark" id="print_excel">导出</button>
                                        </div>
                                        <br>
                                    </form>
                                    <br/>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>考生列表</h2>
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li>
                                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="demo">
                                        <table class="zebra bulk_action" id="score_table" class=display>
                                            <!--<tr id="score_tr">
                                            </tr>-->
                                            <thead>
                                            	<tr>
                                            		<th>学号</th>
                                            		<th>姓名</th>
                                            		<th>状态</th>
                                            		<th>ip</th>
                                            		<th>成绩</th>
                                            		<th>操作</th>
                                            	</tr>
                                            </thead>
                                            <tbody id="tablebody">
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- <div class="pageNumber col-md-3 col-md-offset-9">
                                        <ul class="page-list" id="page-list">
                                        </ul>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
        </div>
    </div>
	
	<script src="../exam/js/menu.js"></script>
	<script id="tpl" type="text/x-handlebars-template">
		{{#each func}}
		<button type="button" class="btn btn-{{this.type}} btn-sm" onclick="{{this.fn}}">{{this.name}}</button> {{/each}}
	</script>
        
    <script type="text/javascript">
    	$(function () 
		 {
    		$.ajax
			({
	      	    url: "" + ServerIp + "/StudentManage/Menu", //加上这句话
	            type: 'POST',				//请求的类型
	            async: false,
	            dataType: "text",			//数据类型		          
	            data: {					         		            
	            },					            
	            success:function(data) 	 //操作后台的返回值
	            {
	            	//alert(data);
	            	data = JSON.parse(data);		           
	            	$("#menu").append(data);		            	
				},
	            error: function(e)
	            {
	            	alert("error");
	            }
		    });
		})
    </script>

    <script>
    var currentPage = 1;

	function DestroyTable()//清除datatable表格内容以供刷新
        {
        	var datatable = $("#score_table").dataTable();
        	if (datatable) 
        	{
	         	datatable.fnClearTable();    //清空数据
	         	datatable.fnDestroy();         //销毁datatable
       	 	} 

        }
	function myFunction()
	{	var totalPage = 0;
        var pageSize = 0;
        var firstPage = 0;
        var lastPage = 0;
        //定义按钮模板
		var tpl = $("#tpl").html();				
		
		//预编译模板
		var template = Handlebars.compile(tpl);
        // var pageList = $('.page-list');
        var tablebody = $('#tablebody');
        document.getElementById("tablebody").innerHTML = '';
		
		$.ajax({
			url: "" + ServerIp + "/ScoreManage/selectScore/",
			type: 'POST', //请求的类型
			async: false,
			dataType: "text", //数据类型
			data: { "currentPage": currentPage,
		            "cl_id": $("#student_class").val(),
		            "ex_id": $("#exam").val()
			},
			success: function(data) //操作后台的返回值
			{	
				data = JSON.parse(data);
				//alert(data.data);		 
//					while (i<data.length)
//					{
//						data = data[i][]
//					}
//					totalPage = data.totalPage;
//		            pageSize = data.pageSize;
//		            firstPage = data.firstPage;
//		            lastPage = data.lastPage;
//		            currentPage = data.currentPage; 
				table = $('#score_table').DataTable({
					dom: 'Bfrtip',
					data: data,
					"paging": false, //禁止分页
					retrieve: true, //实例化检索
					"columns": [
						{
							data:'st_id'
					    },
					    {
							data: 'st_name'
					    },
					    {
							data:'in_state'
					    },
					    {
							data:'in_ip'
					    },
					    {
							data:'in_score'
					    },
						{
								data: null//占位空列
						} 

					], 
					"columnDefs": 
							[
								{
									"searchable": false,
									"orderable": false,
									"targets": [0. - 1]					// 表格填充的范围,[0,-1]为所有
								},
								{
									"targets": -1,
									"render": function(a, b, c, d) 
									{		
											var context =
											{
												func: 
												[
													{
														"name": "重新阅卷",
														"fn": "RestartsinglereadExam(\'" + c.st_id + "\')",
														"type": "primary"
														
													}, //添加按键     name为按键属性
												]
											};
											var html1 = template(context);
										return html1;	
										
											
										
									}
								},
							]
				});		
			}
			
		});
	}
	function RestartsinglereadExam(st_id) {
    	alert(st_id);
        $.post("" + ServerIp + "/ExamManage/RestartsinglereadExam", {
            "st_id": st_id,
            "ex_id": $("#exam").val()
        }, function(data) {
        	DestroyTable();
            myFunction();
        });
    } 
    $("#search").click(function() { 
        myFunction();
    })
    $(document).ready(function() {
        $.post("" + ServerIp + "/StrategyManage/GetAllExam", {}, function(data) {
            var data = JSON.parse(data);
            for (var i = 0; i < data.body.length; i++) {
                $("#exam").append("<option value = '" + data.body[i].ex_id + "'>" + data.body[i].ex_name + "</option>");
            }
            ex_id = data.body[0].ex_id;
            fill_class();
        });
        $(".select2_single").select2({
            allowClear: true
        });
    });

    function fill_class() {
        $.post("" + ServerIp + "/StudentManage/GetClassByExam", {
            "ex_id": ex_id,
        }, function(data) {
            var data = JSON.parse(data);
            $("#student_class").html("");
            for (var i = 0; i < data.body.length; i++) {
                $("#student_class").append("<option value = '" + data.body[i].cl_id + "'>" + data.body[i].cl_name + "</option>");
            }
            if ($("#student_class").val() == null) {
                 //alert("该考试没有教务班参加");
                 DestroyTable();
                 myFunction();
            } else {
            	DestroyTable();
                myFunction();
            }

        });
    }
    $(function() {
        $("#exam").select2();
        $("#exam").change("select2:select", function() {
            ex_id = $(this).val();
            fill_class();
        });
    });
    $(function() {
        $("#student_class").select2();
        $("#student_class").change("select2:select", function() {
        	DestroyTable();
            myFunction();
        });
    });
    
    
    //导出成绩
    $("#print_excel").click(function() {
        $("#score_table").table2excel({
            exclude: ".noExl", //不导出的表格数据选择器，不导出的数据加class加上 noExl就可以了  
            name: "Excel Document Name",
            filename: $("#exam option:selected").html()+"-"+  $("#student_class option:selected").html() ,
            fileext: ".xls",
            exclude_img: true,
            exclude_links: true,
            exclude_inputs: true
        });

        // $.post("" + ServerIp + "/ScoreManage/selectScore/", {}, function(data) {
        //     var data = JSON.parse(data);
        //     datatable = $('#mytable').dataTable({
        //         data: data,
        //         columns: [{
        //             data: 'st_name'
        //         }, {
        //             data: 'st_id'
        //         }, {
        //             data: 'author'
        //         }, {
        //             data: 'booktype'
        //         }, {
        //             data: 'size'
        //         }, {
        //             data: 'stocknum'
        //         }, {
        //             data: 'price'
        //         }, {
        //             data: 'price'
        //         }],
        //         select: true,
        //         tabIndex: -1,
        //         dom: "Bfrtip",
        //         buttons: [{
        //             extend: "csv",
        //             className: "btn-sm"
        //         }, {
        //             extend: "excel",
        //             className: "btn-sm"
        //         }, {
        //             extend: "print",
        //             className: "btn-sm",
        //             title: '<h1 style="text-align:center">图书一览表<h1>',
        //             message: '<p style="text-align:center">制表日期:' + new Date() + '</p><br /><br /><p style="float:left">制表人（签字）:</p><p style="float:right;margin-right:200px">审核人（签字）:</p><br />',
        //             header: false,
        //             footer: false
        //         }, ],
        //         responsive: true
        //     });

    })
    // $(document).ready(function() {
    //     $.get("http://127.0.0.1:8080/getdata", {}, function(data) {
    //         var data = JSON.parse(data);
    //         datatable = $('#mytable').dataTable({
    //             data: data,
    //             columns: [{
    //                 data: 'booknum'
    //             }, {
    //                 data: 'bookname'
    //             }, {
    //                 data: 'author'
    //             }, {
    //                 data: 'booktype'
    //             }, {
    //                 data: 'size'
    //             }, {
    //                 data: 'stocknum'
    //             }, {
    //                 data: 'price'
    //             }, {
    //                 data: 'price'
    //             }],
    //             select: true,
    //             tabIndex: -1,
    //             dom: "Bfrtip",
    //             buttons: [{
    //                 extend: "csv",
    //                 className: "btn-sm"
    //             }, {
    //                 extend: "excel",
    //                 className: "btn-sm"
    //             }, {
    //                 extend: "print",
    //                 className: "btn-sm",
    //                 title: '<h1 style="text-align:center">图书一览表<h1>',
    //                 message: '<p style="text-align:center">制表日期:' + new Date() + '</p><br /><br /><p style="float:left">制表人（签字）:</p><p style="float:right;margin-right:200px">审核人（签字）:</p><br />',
    //                 header: false,
    //                 footer: false
    //             }, ],
    //             responsive: true
    //         });
    //         myFunction(data);
    //     });
    //     $.get("http://127.0.0.1:8080/gettype", {}, function(data) {
    //         // myFunction(data);
    //         var booktype = $("#booktype");
    //         var data = JSON.parse(data);
    //         for (var i = 0; i < data.length; i++) {
    //             booktype.append("<option value = '" + data[i].booktype + "'>" + data[i].booktype + "</option>");
    //         }
    //     });
    // });
    </script>
</body>

</html>