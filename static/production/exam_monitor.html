<!DOCTYPE html>
<html lang="en"> 

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>考试后台管理系统</title>
    <script src="../exam/js/config.js"></script>
    <!-- jQuery -->
    
    <script type="text/javascript" charset="utf8" src="../exam/js/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/js/jquery.js"></script>
	<!-- DataTables -->
	<link rel="stylesheet" type="text/css" href="../exam/css/jquery.dataTables.css">
	<script type="text/javascript" charset="UTF-8" src="../exam/js/jquery.dataTables.js"></script>
	<script src="../exam/js/bootstrap.min.js"></script>
	<script src="../exam/js/handlebars-v3.0.1.js"></script>

	<!--DataTablesButtons-->
	<link rel="stylesheet" href="../exam/Buttons-1.5.1/css/buttons.dataTables.min.css">
	<script type="text/javascript" charset="utf8" src="../exam/Buttons-1.5.1/js/dataTables.buttons.min.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/Buttons-1.5.1/js/buttons.html5.min.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/Buttons-1.5.1/js/dataTables.buttons.min.js"></script>
	<script type="text/javascript" charset="utf8" src="../exam/Buttons-1.5.1/js/buttons.print.js"></script>
    
    	
    <!-- Bootstrap -->   
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <link href="../vendors/select2/dist/css/select2.min.css" rel="stylesheet">
    
    <!--侧边栏-->
  	<!--<script src="../exam/js/menu.js"></script>-->
  	

    <!-- Bootstrap -->
    <!--<script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>-->
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../vendors/select2/dist/js/select2.full.min.js"></script>
    
    <!--<script src="../exam/js/AuthorityManagement.js"></script><-->			<!--权限控制session-->
  
    <style>
    table {
        *border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ccc;
        text-decoration: none;
        table-layout: fixed;
    }

    .zebra td,
    .zebra th {
        padding: 10px;
        /*border-bottom: 1px solid #f2f2f2;*/
        border-left: 1px solid #ccc;
        border-top: 1px solid #ccc;
        text-align: center;
    }

    .zebra .alternate,
    .zebra tbody tr:nth-child(even) {
        background: #f5f5f5;
        box-shadow: 0 1px 0 rgba(255, 255, 255, .8) inset;
    }

    .zebra th {
        text-align: center;
        text-shadow: 0 1px 0 rgba(255, 255, 255, .5);
        border-bottom: 1px solid #ccc;
        background-color: #eee;
        background-image: -webkit-gradient(linear, left top, left bottom, from(#f5f5f5), to(#eee));
        background-image: -webkit-linear-gradient(top, #f5f5f5, #eee);
        background-image: -moz-linear-gradient(top, #f5f5f5, #eee);
        background-image: -ms-linear-gradient(top, #f5f5f5, #eee);
        background-image: linear-gradient(top, #f5f5f5, #eee);
        filter: progid: DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#f5f5f5, endColorstr=#eee);
        -ms-filter: "progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#f5f5f5,endColorstr=#eee)";
    }
    /*.zebra th:first-child {
        border-radius: 6px 0 0 0;
        width: 50px;
    }*/

    .zebra th:last-child {
        border-radius: 0 6px 0 0;
        width: 120px;
    }

    .zebra tr:last-child td:first-child {
        border-radius: 0 0 0 6px;
    }

    .zebra td:last-child {
        border-radius: 0 0 6px 0;
    }

    .pageNumber {
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        background: #dddddd;
        height: 40px;
        width: auto;
    }

    td {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        text-align: center;
    }

    .td0 {
        width: 50%;
        text-align: left;
    }

    .td1 {
        width: 12%;
    }

    a {
        cursor: pointer;
    }
    </style>
    <style>
    ul.pagination {
        display: inline-block;
        padding: 0;
        margin: 0;
        float: right;
    }

    ul.pagination li {
        display: inline;
    }

    ul.pagination li a {
        color: black;
        float: right;
        padding: 8px 16px;
        text-decoration: none;
        transition: background-color .3s;
        border: 1px solid #ddd;
    }

    ul.pagination li a.active {
        background-color: #4CAF50;
        color: white;
        border: 1px solid #4CAF50;
    }

    ul.pagination li a:hover:not(.active) {
        background-color: #ddd;
    }
    </style>
</head>

<body class="nav-md"  style="background-image: url(../vendors/tushuguan.jpg);background-repeat: no-repeat;background-size: cover;">
    <div class="container body">
        <div class="main_container" >
            <div id="menu">
             <!--加载侧边栏-->
            </div>
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="page-title">
                        <div class="title_left">
                            <h3>考试监控 </h3>
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <!-- <h2>新建考试</h2> -->
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li>
                                            <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                        </li>
                                    </ul>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    </br>
                                    <form class="form-horizontal form-label-left" id="class_data">
                                        <div>
                                            <label class="control-label col-md-1 col-sm-1 col-xs-6" style="float: left;">考试选择</label>
                                            <div class="col-md-3 col-sm-9 col-xs-6" style="float: left;">
                                                <select class="select2_single form-control" id="exam">
                                                </select>
                                                &nbsp;&nbsp;
                                            </div>
                                        </div>
                                        <div>
                                            <label class="control-label col-md-1 col-sm-3 col-xs-12" style="float: left;">教务班选择</label>
                                            <div class="col-md-3 col-sm-9 col-xs-12" style="float: left;">
                                                <select class="select2_single form-control" id="student_class">
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <button type="button" onclick="StopExamByUser()" class="btn btn-success">停止考试</button>
                                            <button type="button" onclick="EmptyIP()" class="btn btn-success">清空IP</button>
                                        </div>
                                    </form>
                                    <br/>
                                    <div class="form-group">
                                        <label id="start_time" style="width: 15%;">开始时间:</label>
                                        <label id="end_time" style="width: 15%;">结束时间:</label>
                                        <label id="total_num" style="width: 15%;">总人数:</label>
                                        <label id="login_num" style="width: 15%;">在线人数:</label>
                                        <label id="lack_num" style="width: 15%;">缺考人数:</label>
                                    </div>
                                    </form>
                                    <table class="zebra bulk_action" id="exam_info">
                                    	<thead>
	                                        <tr>
	                                            <th>学号</th>
	                                            <th>姓名</th>
	                                            <th>IP</th>
	                                            <th>学生状态</th>
	                                            <th style="width: 20%;">操作</th>
	                                        </tr>
                                        </thead>
                                        <tbody id="my_body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
        </div>
    </div>
	<!--定义延时按钮-->
	<script id="tpl" type="text/x-handlebars-template">
		{{#each func}}
		<button type="button" class="btn btn-{{this.type}} btn-sm" onclick="{{this.fn}}">{{this.name}}</button> {{/each}}
	</script>
	<!--定义换机操作按钮-->
	<script id="tp2" type="text/x-handlebars-template">
		{{#each func}}
		<button type="button" class="btn btn-{{this.type}} btn-sm" data-toggle="modal" data-target="#myModal" onclick="{{this.fn}}">{{this.name}}</button> {{/each}}
	</script>
	<!--定义违纪操作按钮-->
	<script id="tp3" type="text/x-handlebars-template">
		{{#each func}}
		<button type="button" class="btn btn-{{this.type}} btn-sm" data-toggle="modal" data-target="#myModal" onclick="{{this.fn}}">{{this.name}}</button> {{/each}}
	</script>
	<!--定义重做操作按钮-->
	<script id="tp4" type="text/x-handlebars-template">
		{{#each func}}
		<button type="button" class="btn btn-{{this.type}} btn-sm" data-toggle="modal" data-target="#myModal" onclick="{{this.fn}}">{{this.name}}</button> {{/each}}
	</script>
	
	<script src="../exam/js/menu.js"></script>
        
    <script type="text/javascript">
    	$(function () 
		 {
    		$.ajax
			({
	      	    url: "" + ServerIp + "/StudentManage/Menu", //加上这句话
	            type: 'POST',				//请求的类型
	            async: false,
	            dataType: "text",			//数据类型		          
	            data: {					         		            
	            },					            
	            success:function(data) 	 //操作后台的返回值
	            {
	            	//alert(data);
	            	data = JSON.parse(data);		           
	            	$("#menu").append(data);		            	
				},
	            error: function(e)
	            {
	            	alert("error");
	            }
		    });
		})
    </script>
    
    <script>
    var ex_id;
    var class_cl_id;
    function DestroyTable_exam()//清除datatable表格内容以供刷新
    {
    	var datatable = $("#exam_info").dataTable();
    	if (datatable) 
    	{
         	datatable.fnClearTable();    //清空数据
         	datatable.fnDestroy();         //销毁datatable
   	 	} 

    }
    $(document).ready(function() {
        // $.post('"+ServerIp+"/StrategyManage/SelectExamQuestionById', {
        //     "ex_id": 1,
        // }, function(data) {
        //     alert(data);
        // })
        $.post("" + ServerIp + "/StrategyManage/GetAllExam", {}, function(data) {
            var data = JSON.parse(data);
            for (var i = 0; i < data.body.length; i++) {
                $("#exam").append("<option value = '" + data.body[i].ex_id + "'>" + data.body[i].ex_name + "</option>");
            }
            ex_id = data.body[0].ex_id;
            fill_class();

        });
    });

    function fill_class() {
    	DestroyTable_exam();
        $.post("" + ServerIp + "/StudentManage/GetClassByExam", {
            "ex_id": ex_id,
        }, function(data) {
            var data = JSON.parse(data);
            $("#student_class").html("");
            for (var i = 0; i < data.body.length; i++) {
                $("#student_class").append("<option value = '" + data.body[i].cl_id + "'>" + data.body[i].cl_name + "</option>");
            }
            class_cl_id = data.body[0].cl_id;

            $.post("" + ServerIp + "/StrategyManage/SelectExamByExamId", {
                "ex_id": ex_id,
            }, function(data) {
                var data = JSON.parse(data);
                $("#start_time").html('开始时间: ' + data.body.ex_time_start);
                $("#end_time").html('结束时间: ' + data.body.ex_time_end);
                fill_student();
            });
        });
    }
    $(function() {
        $("#exam").select2();
        $("#exam").change("select2:select", function() {
            ex_id = $(this).val();
            DestroyTable_exam()
            fill_class();
        });
    });
    function fill_student()
    {
    	//定义按钮模板
		var tpl = $("#tpl").html();
		var tp2 = $("#tp2").html();	
		var tp3 = $("#tp3").html();
		var tp4 = $("#tp4").html();	
		
		//预编译模板
		var template1 = Handlebars.compile(tpl);
		var template2 = Handlebars.compile(tp2);
		var template3 = Handlebars.compile(tp3);
		var template4 = Handlebars.compile(tp4);
		
		$.ajax({
			type: 'POST', //请求的类型
			url: "" + ServerIp + "/StudentManage/GetStudentByExam",
			async:false,
			dataType:"text",
			data:{
				"ex_id": ex_id,
           		"class_cl_id": class_cl_id
			},
            success:function(data)
            {
            	//alert(data);
            	data=JSON.parse(data); 
            	table=$('#exam_info').DataTable({
     				data: data.body,
            		"paging": false, //禁止分页
					retrieve: true, //实例化检索
					"columns": [
							    {
									data: 'student_st_id'
							    },
							    {
									data: 'student_name'
							    },
							    {
									data: 'in_ip'
							    },
							    {
									data: 'in_state'
							    },
								{
									data: null//占位空列
								} 
							],
							"columnDefs": 
							[
								{
									"searchable": false,
									"orderable": false,
									"targets": [0. - 1]					// 表格填充的范围,[0,-1]为所有
								},
								{
									"targets": 4,
									"render": function(a, b, c, d) 
									{
										var context1 =
											{
												func: 
												[
													{
														"name": "延时",
														"fn": "delay_exam(\'" + c.in_state + "\',\'" + c.in_id + "\')",
														"type": "danger"
														
													}, //添加按键     name为按键属性
												]
											};
											var html1 = template1(context1);
											var context2 = 
											{
												func: 
												[
													{
														"name": "换机",
														"fn":"change_pc(\'" + c.in_state + "\',\'" + c.in_id + "\')",
														"type": "primary"
													},
												]
											};						
											var html2 = template2(context2);
											var context3 = 
											{
												func: 
												[
													{
														"name": "违纪",
														"fn":"stop_exam(\'" + c.in_state + "\',\'" + c.in_id + "\')",
														"type": "info"
													},
												]
											};						
											var html3 = template3(context3);
											var context4 = 
											{
												func: 
												[
													{
														"name": "重做",
														"fn":"recover(\'" + c.in_id + "\')",
														"type": "success"
													},
												]
											};						
											var html4 = template4(context4);
										return html1 + html2 + html3 + html4;
									}
								},
							]
           		 });
           		$("#total_num").html('总人数: ' + data.body.length);
		        var login_num = data.body.length - parseInt(data.message);
		        $("#login_num").html('已参加人数: ' + login_num);
		        $("#lack_num").html('未参加人数: ' + data.message);
            }
		});
    }

    function delay_exam(in_state,in_id) {
        if(in_state!='正在考试'){
            alert("学生不在考试状态");
            return;
        }
        var delay_time = prompt('延长时间(分钟)？', '');
        if (delay_time == '' || typeof(delay_time) == 'undefined' || delay_time == null) {
            alert('您输入的数据不合法');
        } else {
            $.post("" + ServerIp + "/ExamManage/delay_exam", {
                "in_id": in_id,
                "delay_time": delay_time,
            }, function(data) {
                var data = JSON.parse(data);
                if (data.status == 1) {
                    alert("success");
                    DestroyTable_exam();
                    fill_student();
                } else {
                    alert("error");
                }
            });
        }
    }

    function change_pc(in_state,in_id) {
        if(in_state!='正在考试'){
            alert("学生不在考试状态");
            return;
        }
        $.post("" + ServerIp + "/ExamManage/change_pc", {
            "in_id": in_id,
        }, function(data) {
            var data = JSON.parse(data);
            if (data.status == 1) {
            	DestroyTable_exam();
                fill_student();
            } else {
                alert("error");
            }
        });
    }
    // 单个停止,标记为作弊
    function stop_exam(in_state,in_id) {
        if(in_state!='正在考试'){
            alert("学生不在考试状态");
            return;
        }
        $.post("" + ServerIp + "/ExamManage/stop_exam", {
            "in_id": in_id,
        }, function(data) {
            var data = JSON.parse(data);
            if (data.status == 1) {
            	DestroyTable_exam();
                fill_student();
            } else {
                alert("error");
            }
        });
    }
    // 重做，刷新学生状态
    function recover(in_id) {
        $.post("" + ServerIp + "/ExamManage/recover_exam", {
            "in_id": in_id,
        }, function(data) {
            var data = JSON.parse(data);
            if (data.status == 1) {
            	DestroyTable_exam();
                fill_student();
            } else {
                alert("error");
            }
        });
    }
    
    // 停止整个班的考试
    function StopExamByUser() {
        // alert("stop");
        $.post("" + ServerIp + "/ExamManage/StopExamByClass", {
            "ex_id": ex_id,
            "class_cl_id": class_cl_id,
        }, function(data) {
            var data = JSON.parse(data);
            if (data.status == 1) {
            	DestroyTable_exam();
                fill_student();
            } else {
                alert("error");
            }
        });
    }

    //清空IP
    function EmptyIP(data) {
        $.post("" + ServerIp + "/ExamManage/EmptyIP", {
        }, function(data) {
            var data = JSON.parse(data);
            if (data.status == 1) {
                alert("清空IP成功");
                DestroyTable_exam();
                fill_class();
            } else {
                alert("error");
            }
        });
    }
    $(function() {
        $("#student_class").select2();
        $("#student_class").change("select2:selecting", function() {
            class_cl_id = $(this).val();
            DestroyTable_exam();
            // alert("class_cl_id"+$(this).val());
            fill_student();
        });
    });
    $(document).ready(function() {
        $(".select2_single").select2({
            placeholder: "请选择一个班级",
            allowClear: true
        });
        $(".select2_group").select2({});
    });
    </script>
</body>

</html>